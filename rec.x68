        org     $1000

rec:
        dc.l    $0042695c, $00400000, $00500010
        dc.l    $000037f8, $00400000, $00c00020
        dc.l    $00043aed, $00900000, $00a00010
        dc.l    $00476c52, $00a00000, $00c00010
        dc.l    $00476c51, $00c00000, $00d00010
        dc.l    $00476c52, $00300010, $00400020
        dc.l    $00043aec, $00c00010, $00d00020
        dc.l    $0047704d, $00300020, $00400030
        dc.l    $00007eae, $00400020, $00600030
        dc.l    $000480b3, $00600020, $00700030
        dc.l    $0046a2ff, $00500020, $00b00070
        dc.l    $00419ff9, $00800020, $00900030
        dc.l    $000480b3, $00900020, $00a00030
        dc.l    $00469ef3, $00a00020, $00b00030
        dc.l    $0047704d, $00200030, $00300060
        dc.l    $000480b3, $00300030, $00400040
        dc.l    $00419ff9, $00400030, $00500040
        dc.l    $000480b2, $00500030, $00600040
        dc.l    $00419ffa, $00600030, $00700040
        dc.l    $00419ffa, $00800030, $00900040
        dc.l    $000882b7, $00900030, $00a00040
        dc.l    $00419ffa, $00a00030, $00b00040
        dc.l    $0046a2ff, $00b00030, $00c00040
        dc.l    $00469ff4, $00c00030, $00d00040
        dc.l    $004b7352, $00d00030, $00e00040
        dc.l    $000480b2, $00300040, $00400050
        dc.l    $003d9df5, $00400040, $00500050
        dc.l    $000480b3, $00500040, $00600050
        dc.l    $000882b7, $00600040, $00700050
        dc.l    $0045a1fe, $00800040, $00900050
        dc.l    $003d9df5, $00900040, $00a00050
        dc.l    $000480b2, $00a00040, $00b00050
        dc.l    $00419ff9, $00b00040, $00c00050
        dc.l    $00419ff9, $00c00040, $00d00050
        dc.l    $00469ef3, $00d00040, $00e00050
        dc.l    $00007eae, $00300050, $00400060
        dc.l    $000480b3, $00400050, $00500060
        dc.l    $00419ff9, $00800050, $00900060
        dc.l    $00007eae, $00900050, $00c00060
        dc.l    $00047da7, $00c00050, $00d00060
        dc.l    $004b7352, $00400060, $00500070
        dc.l    $00469ef3, $00b00060, $00c00070
        dc.l    $00427153, $00300070, $00400080
        dc.l    $00007eae, $00200070, $005000a0
        dc.l    $000079b2, $00500070, $006000a0
        dc.l    $00003bf3, $00600070, $00700090
        dc.l    $00007eae, $00700070, $00800080
        dc.l    $00007dae, $00800070, $00900080
        dc.l    $000479ac, $00900070, $00a00080
        dc.l    $0047704d, $00a00070, $00c00080
        dc.l    $0047704d, $00c00070, $00d00080
        dc.l    $00427153, $00200080, $00300090
        dc.l    $000079b2, $00700080, $00800090
        dc.l    $000075b6, $00800080, $00900090
        dc.l    $00003bf3, $00900080, $00a000a0
        dc.l    $00007eae, $00a00080, $00e000a0
        dc.l    $00047da7, $00c00080, $00d00090
        dc.l    $0047704d, $00d00080, $00e00090
        dc.l    $000037f8, $00400090, $00b000e0
        dc.l    $0046a2ff, $002000a0, $003000c0
        dc.l    $00419ff9, $003000a0, $004000b0
        dc.l    $000079b2, $004000a0, $005000b0
        dc.l    $00043df8, $005000a0, $006000b0
        dc.l    $00419bfe, $006000a0, $007000b0
        dc.l    $00043df8, $008000a0, $009000b0
        dc.l    $00419bfe, $009000a0, $00a000b0
        dc.l    $00003bf3, $00a000a0, $00b000b0
        dc.l    $000480b3, $00b000a0, $00c000b0
        dc.l    $0046a2ff, $00c000a0, $00e000c0
        dc.l    $0045a1fe, $003000b0, $004000c0
        dc.l    $003d95fe, $004000b0, $005000c0
        dc.l    $00043df8, $00a000b0, $00b000c0
        dc.l    $00419bfe, $00b000b0, $00c000c0
        dc.l    $00469ef3, $002000c0, $003000d0
        dc.l    $004198f3, $003000c0, $004000d0
        dc.l    $000037f7, $006000c0, $007000d0
        dc.l    $00043aec, $007000c0, $008000d0
        dc.l    $00043aed, $008000c0, $009000d0
        dc.l    $00043df7, $00b000c0, $00c000d0
        dc.l    $00469ef3, $00c000c0, $00e000d0
        dc.l    $00476c52, $003000d0, $004000e0
        dc.l    $00043aec, $006000d0, $007000e0
        dc.l    $00476c52, $008000d0, $009000e0
        dc.l    $00043aec, $00b000d0, $00c000e0
        dc.l    $0047704d, $002000e0, $003000f0
        dc.l    $00007eae, $002000e0, $00500100
        dc.l    $00047da7, $005000e0, $00600100
        dc.l    $0047704d, $009000e0, $00a00100
        dc.l    $00007eae, $00a000e0, $00e00100
        dc.l    $00047da7, $00c000e0, $00d000f0
        dc.l    $ffffffff                       ; end sequence

scrwidth equ    640                             ; screen width
scrheight equ   480                             ; screen height

start:
        ; jsr     scrinit

        ; drawbm subroutine call
        move.l  #rec, -(a7)                     ; bitmap address
        move.w  #1, -(a7)                       ; y pos
        move.w  #2, -(a7)                       ; x pos
        jsr     drawrec
        sub     #12, a7                         ; pop stack

        ; jsr     scrplot

        ; halt simulator
        move.b  #9, d0
        trap    #15

scrinit:
        movem.l d0-d1, -(a7)

        ; set screen resolution
        move.b  #33, d0
        move.l  #scrwidth<<16|scrheight, d1
        trap    #15

        ; set windowed mode
        move.l  #1, d1
        trap    #15

        ; clear screen
        move.b  #11, d0
        move.l  #$ff00, d1
        trap    #15

        ; enable double buffer
        move.b  #92, d0
        move.b  #17, d1
        trap    #15

        movem.l (a7)+, d0-d1
        rts

scrplot:
        movem.l d0-d1, -(a7)

        ; change screen buffer
        move.b  #94, d0
        trap    #15

        ; clear screen
        move.b  #11, d0
        move.l  #$ff00, d1
        trap    #15

        movem.l (a7)+, d0-d1
        rts

drawrec:
; arguments:
;       sp+0 (x pos)                    -> d3
;       sp+1 (y pos)                    -> d4
;       sp+2 (bitmap address high word) -> a0
;       sp+3 (bitmap address low word)  -> a0
        movem.w d0-d6, -(a7)
        move.l  a0, -(a7)

        ; get subroutine arguments
        movem.w 22(a7), d5-d6
        move.l  26(a7), a0

.loop:
        ; set fill color
        move.l  (a0)+, d1
        move.l  d1, d2
        eor.l   #$ffffffff, d2                  ; detect end sequence
        beq     .done
        move.b  #80, d0
        trap    #15
        move.b  #81, d0
        trap    #15

        ; get source coordinates
        move.w  (a0)+, d1
        move.w  (a0)+, d2
        move.w  (a0)+, d3
        move.w  (a0)+, d4

        ; draw rectangle
        move.b  #87, d0
        add.w   d5, d1
        add.w   d5, d3
        add.w   d6, d2
        add.w   d6, d4
        trap    #15
        bra     .loop

.done:
        move.l  (a7)+, a0
        movem.w (a7)+, d0-d6
        rts

        end     start

